<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>a-frame copresence</title>
    <script src="https://aframe.io/releases/1.0.4/aframe.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script>
        var socket = io();

        function sendPosition(position, rotation) {
            socket.emit('update-pos', { position, rotation });
        }

        // TODO: make this a class, keep track of all with map of ids

        function findVisitorRepr(id) {
            let el = document.querySelector('#user-' + id);
            return el;
        }

        function deleteVisitorRepr(id) {
            let el = document.querySelector('#user-' + id);
            if (el != null) {
                console.log("Deleting element for " + id);
                el.parentNode.removeChild(el);
            } else {
                console.warn("Couldn't find element to delete for " + id);
            }
        }

        function createVisitorRepr(id) {
            var sceneEl = document.querySelector('a-scene');
            var el = document.createElement('a-entity');
            el.id = 'user-' + id;

            var headEl = document.createElement('a-cone');
            headEl.setAttribute('height', 0.5);
            headEl.setAttribute('radius-bottom', 0.25);
            // rotate to point towards camera direction
            headEl.object3D.rotation.x = Math.PI / 2;
            el.appendChild(headEl);

            // line for pointing
            var lineEl = document.createElement('a-entity');
            lineEl.setAttribute('line', {
                start: { x: 0, y: 0, z: 0 }, 
                end: {x: 0, y: 0, z: -5},
                color: 'red',
                visible: true,
            });
            el.appendChild(lineEl);

            // name text
            var textEl = document.createElement('a-text');
            textEl.setAttribute('value', id);
            textEl.setAttribute('align', 'center');
            textEl.getAttribute('position').y = 0.5;
            textEl.object3D.rotation.y = Math.PI;
            el.appendChild(textEl);
            // make a second to point backwards
            var textEl2 = textEl.cloneNode();
            textEl2.getAttribute('position').y = 0.5;
            el.appendChild(textEl2);

            sceneEl.appendChild(el);
            return el;
        }

        // add/update elements for other users
        socket.on('visitor-update-pos', function (msg) {
            console.log('new update', msg);

            let el = findVisitorRepr(msg.id);
            if (el == null) {
                el = createVisitorRepr(msg.id);
                console.debug("Created new object for user " + msg.id, el);
            }
            el.setAttribute('position', msg.position);
            // el.object3D.position.set(msg.pos.position);
            el.object3D.setRotationFromQuaternion(msg.rotation);
        });

        socket.on('visitor-disconnect', function (msg) {
            const id = msg.id;
            deleteVisitorRepr(id);
        })

        AFRAME.registerComponent('rotation-reader', {
            /**
             * We use IIFE (immediately-invoked function expression) to only allocate one
             * vector or euler and not re-create on every tick to save memory.
             */
            tick: (function () {
                var position = new THREE.Vector3();
                var rotation = new THREE.Quaternion();

                var old_position = new THREE.Vector3();
                var old_rotation = new THREE.Quaternion();

                return function () {
                    this.el.object3D.getWorldPosition(position);
                    this.el.object3D.getWorldQuaternion(rotation);
                    // position and rotation now contain vector and quaternion in world space.

                    // only send on "significant" change
                    // TODO: optimize this
                    if (position.distanceTo(old_position) > 0.1 || rotation.angleTo(old_rotation) > Math.PI / 16) {
                        console.log("postion updated");
                        // hotfix quaternion properties for sending
                        sendPosition(position, {x: rotation._x, y: rotation._y, z: rotation._z, w: rotation._w});
                        this.el.object3D.getWorldPosition(old_position);
                        this.el.object3D.getWorldQuaternion(old_rotation);
                    }
                };
            })()
        });

        window.addEventListener('load', () => {
            let el = createVisitorRepr('debug');
            el.setAttribute('position', {x: 0, y: 1.6, z: 0});
            console.log('Added debug visitor ', el);
        });
    </script>
</head>

<body>
    <a-scene>
        <a-box position="-1 0.5 -3" rotation="0 45 0" color="#4CC3D9"></a-box>
        <a-sphere position="0 1.25 -5" radius="1.25" color="#EF2D5E"></a-sphere>
        <a-cylinder position="1 0.75 -3" radius="0.5" height="1.5" color="#FFC65D"></a-cylinder>
        <a-plane position="0 0 -4" rotation="-90 0 0" width="4" height="4" color="#7BC8A4"></a-plane>
        <a-sky color="#ECECEC"></a-sky>

        <!-- <a-entity camera look-controls rotation-reader></a-entity> -->
        <a-entity camera="active: true" look-controls wasd-controls position="0 1.6 0" rotation-reader></a-entity>
        <!-- <a-entity raycaster="showLine: true; far: 5" line="color: orange; opacity: 0.5" position="0 1.6 0"></a-entity> -->
        <!-- <a-sphere raycaster="showLine: true; far: 5"></a-sphere> -->
    </a-scene>
</body>

</html>